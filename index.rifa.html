<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<title>üéüÔ∏è Rifa Solid√°ria</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@600&family=Inter:wght@400;600&display=swap" rel="stylesheet">
<style>
:root{
  --bg1:#060818; --bg2:#0a0f2c; --card:#0f172a; --line:#1e2a3f;
  --text:#eaf2ff; --muted:#a7b3c8; --accent:#00e5ff; --accent2:#7c3aed; --ok:#16a34a; --warn:#f59e0b; --bad:#ef4444;
}
*{box-sizing:border-box} body{margin:0;font-family:Inter,system-ui;background:radial-gradient(1000px 600px at 50% -150px,var(--bg2),#040612 70%);color:var(--text)}
.wrap{max-width:980px;margin:0 auto;padding:16px 16px 60px}

/* Banner topo (use PNG sem fundo) */
.banner{
  height:180px; display:flex; align-items:center; justify-content:center;
  background:linear-gradient(180deg,#0b1334,transparent); position:relative; overflow:hidden;
  border-bottom:1px solid rgba(255,255,255,.06);
}
.banner img{max-height:160px;object-fit:contain;filter:drop-shadow(0 0 14px rgba(0,229,255,.6)); animation:float 5s ease-in-out infinite}
@keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-6px)}}

/* Header */
h1{font-family:Orbitron,system-ui;font-size:28px;text-align:center;margin:14px 0 6px;color:var(--warn);text-shadow:0 0 10px rgba(245,158,11,.6)}
.sub{text-align:center;color:var(--muted);margin-bottom:14px}

/* Painel topo */
.panel{
  background:linear-gradient(180deg,var(--card),#0a0f1f);
  border:1px solid var(--line); border-radius:16px; padding:14px; display:flex; flex-wrap:wrap; gap:12px; align-items:center; justify-content:space-between;
  box-shadow:0 0 22px rgba(0,229,255,.08);
}
.kpi{display:flex;align-items:center;gap:10px}
.badge{font-size:12px;background:#0b1223;border:1px solid var(--line);padding:6px 10px;border-radius:10px;color:var(--muted)}
.price{color:var(--warn);font-weight:800}
.total{color:var(--warn);font-weight:800}
.actions{display:flex;gap:10px;align-items:center}
.btn{
  border:none;border-radius:10px;padding:12px 14px;font-weight:800;cursor:pointer;transition:.25s;font-size:14px
}
.btn-primary{background:linear-gradient(90deg,var(--accent2),var(--accent)); color:#06121a; box-shadow:0 0 12px rgba(0,229,255,.35)}
.btn-primary:disabled{filter:grayscale(1) brightness(.6); cursor:not-allowed; box-shadow:none}
.btn-clear{background:#102038;color:#dbe7ff;border:1px solid var(--line)}
.hint{font-size:12px;color:var(--muted)}

/* Grid */
.grid{
  margin-top:16px;
  display:grid; grid-template-columns:repeat(10,1fr);
  gap:10px; background:linear-gradient(180deg,#0b1328,#080e1d); padding:16px;border:1px solid var(--line); border-radius:16px;
  box-shadow:inset 0 0 12px rgba(0,229,255,.06);
}
.cell{
  position:relative; aspect-ratio:1/1; display:flex; align-items:center; justify-content:center;
  background:#0c152b; border:1px solid #13213a; color:#d9e6ff; border-radius:12px; font-weight:700; user-select:none; cursor:pointer;
  transition:.2s;
}
.cell:hover{transform:translateY(-2px); box-shadow:0 6px 16px rgba(0,229,255,.18)}
.cell.selected{outline:2px solid var(--accent); box-shadow:0 0 0 4px rgba(0,229,255,.18) inset, 0 0 16px rgba(0,229,255,.3)}
.cell.sold{background:#1a2336;color:#8793aa;border-color:#22314e; cursor:not-allowed; position:relative; opacity:.75}
.cell.sold::after{
  content:"VENDIDO"; position:absolute; bottom:6px; right:6px; font-size:9px; padding:2px 6px; border-radius:6px;
  background:#2a334a; color:#aab6cc; border:1px solid #334462;
}

/* Overlay de carregamento */
.overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.85);z-index:9999;align-items:center;justify-content:center;flex-direction:column}
.loader{width:64px;height:64px;border-radius:50%;border:4px solid #23304a;border-top-color:var(--warn);animation:spin 1s linear infinite;margin-bottom:12px}
.overlay p{color:#b9c6dc}
@keyframes spin{to{transform:rotate(360deg)}}

/* Popup */
.popup{display:none;position:fixed;inset:0;background:rgba(0,0,0,.85);z-index:10000;align-items:center;justify-content:center}
.box{
  width:min(92vw,420px); background:linear-gradient(180deg,var(--card),#0a0f1c);
  border:1px solid var(--line); border-radius:14px; padding:16px; box-shadow:0 0 18px rgba(0,229,255,.25)
}
.box h3{margin:0 0 8px;color:var(--warn);font-family:Orbitron,system-ui;font-size:18px;text-align:center}
.box label{display:block;color:var(--muted);font-size:13px;margin:10px 0 6px}
.box input{width:100%;background:#0b1220;color:var(--text);border:none;border-radius:10px;padding:12px;font-size:15px}
.row{display:flex;gap:10px;margin-top:12px}
.ok{background:linear-gradient(90deg,var(--warn),#ffb757);color:#111}
.cancel{background:#112036;color:#c9d6ec;border:1px solid var(--line)}
.small{font-size:12px;color:var(--muted);text-align:center;margin-top:8px}

/* Responsivo */
@media (max-width:768px){
  .grid{grid-template-columns:repeat(5,1fr)}
  .banner{height:150px}
}
@media (max-width:480px){
  .grid{grid-template-columns:repeat(4,1fr)}
  h1{font-size:24px}
}
</style>
</head>
<body>

<!-- Banner 3D topo (troque a imagem por PNG sem fundo) -->
<div class="banner">
  <img src="https://upload.wikimedia.org/wikipedia/commons/4/47/PNG_transparency_demonstration_1.png" alt="Rifa 3D">
</div>

<div class="wrap">
  <h1>Rifa Solid√°ria</h1>
  <p class="sub">Selecione os n√∫meros desejados e confirme sua participa√ß√£o. Valor por n√∫mero: <b>R$ <span id="precoLabel">10,00</span></b>.</p>

  <div class="panel">
    <div class="kpi">
      <span class="badge">Dispon√≠veis: <b id="disp">‚Äî</b></span>
      <span class="badge">Selecionados: <b id="selCount">0</b></span>
      <span class="badge">Pre√ßo: <span class="price" id="precoTop">R$ 10,00</span></span>
    </div>
    <div class="actions">
      <button id="btnClear" class="btn btn-clear" type="button">Limpar sele√ß√£o</button>
      <button id="btnConfirm" class="btn btn-primary" type="button" disabled>Confirmar participa√ß√£o</button>
    </div>
  </div>

  <!-- grade -->
  <div id="grid" class="grid" aria-live="polite"></div>
  <p class="hint">* N√∫meros marcados como ‚ÄúVENDIDO‚Äù n√£o podem ser selecionados.</p>
</div>

<!-- Overlay carregando -->
<div id="overlay" class="overlay">
  <div class="loader"></div>
  <p>Processando...</p>
</div>

<!-- Popup -->
<div id="popup" class="popup" role="dialog" aria-modal="true">
  <div class="box">
    <h3>Confirmar participa√ß√£o</h3>
    <p class="small">Revise seus n√∫meros e preencha seus dados.</p>
    <div class="badge" style="display:block;text-align:center;margin-bottom:8px">
      Seus n√∫meros: <b id="numsPreview"></b>
    </div>
    <label>Nome completo</label>
    <input id="nome" type="text" placeholder="Seu nome" required>
    <label>E-mail</label>
    <input id="email" type="email" placeholder="seu@email.com" required>
    <label>Telefone / WhatsApp</label>
    <input id="tel" type="tel" placeholder="(00) 00000-0000" maxlength="16" required>
    <div class="row">
      <button id="confirm" class="btn ok" type="button">Enviar</button>
      <button id="cancel" class="btn cancel" type="button">Cancelar</button>
    </div>
    <p class="small">Ap√≥s o envio, seus n√∫meros ser√£o reservados e registrados na planilha.</p>
  </div>
</div>

<script>
/* ====== CONFIG ====== */
const RIFA_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxvPyMzoPqiHQgi6fEVJ_wD0Dsbin3658joI1ujMXFzjHspRH7bYGfipKDSPqoyaaSMHg/exec"; // üëà troque aqui
const TOTAL_NUMEROS = 200;    // grade 1..200
const PRECO = 10;             // R$ por n√∫mero

/* ====== STATE ====== */
const gridEl = document.getElementById('grid');
const btnConfirm = document.getElementById('btnConfirm');
const btnClear = document.getElementById('btnClear');
const selCountEl = document.getElementById('selCount');
const dispEl = document.getElementById('disp');
const precoTopEl = document.getElementById('precoTop');
const precoLabel = document.getElementById('precoLabel');

const overlay = document.getElementById('overlay');
const popup = document.getElementById('popup');
const numsPreview = document.getElementById('numsPreview');
const nomeEl = document.getElementById('nome');
const emailEl = document.getElementById('email');
const telEl = document.getElementById('tel');
const confirmEl = document.getElementById('confirm');
const cancelEl = document.getElementById('cancel');

let vendidos = new Set();
let selecionados = new Set();

/* ====== HELPERS ====== */
const fmt = v => v.toLocaleString('pt-BR',{minimumFractionDigits:2,maximumFractionDigits:2});

function showOverlay(s){overlay.style.display = s ? 'flex':'none'}
function openPopup(){popup.style.display='flex'; setTimeout(()=>nomeEl.focus(),50)}
function closePopup(){popup.style.display='none'}

function renderGrid(){
  gridEl.innerHTML = '';
  let disponiveis = 0;
  for(let n=1;n<=TOTAL_NUMEROS;n++){
    const cell = document.createElement('button');
    cell.type = 'button';
    cell.className = 'cell';
    cell.textContent = n;
    cell.setAttribute('aria-label', 'N√∫mero ' + n);

    const isSold = vendidos.has(n);
    if(isSold){
      cell.classList.add('sold');
      cell.disabled = true;
    }else{
      disponiveis++;
      if(selecionados.has(n)) cell.classList.add('selected');
      cell.addEventListener('click',()=>{
        if(selecionados.has(n)) selecionados.delete(n);
        else selecionados.add(n);
        updatePanel();
        renderGrid();
      });
    }
    gridEl.appendChild(cell);
  }
  dispEl.textContent = disponiveis;
}

function updatePanel(){
  selCountEl.textContent = selecionados.size;
  btnConfirm.disabled = selecionados.size === 0;
}

/* ====== TELEFONE M√ÅSCARA ====== */
telEl?.addEventListener('input', e=>{
  let v = e.target.value.replace(/\D/g,'').slice(0,11);
  v = v.length>10 ? v.replace(/^(\d{2})(\d{5})(\d{4}).*/, '($1) $2-$3')
                  : v.replace(/^(\d{2})(\d{4})(\d{0,4}).*/, '($1) $2-$3');
  e.target.value = v;
});

/* ====== LOAD ====== */
async function loadVendidos(){
  try{
    const r = await fetch(`${RIFA_SCRIPT_URL}?action=vendidos`, {cache:'no-store'});
    if(!r.ok) throw 0;
    const j = await r.json(); // esperado: [4,7,25,...]
    if(Array.isArray(j)) vendidos = new Set(j.map(x=>Number(x)));
  }catch(e){
    // fallback demo (comente se n√£o quiser)
    vendidos = new Set([4,7,25,27,41,55,98,101,170]);
  }
}

async function init(){
  precoTopEl.textContent = 'R$ ' + fmt(PRECO);
  precoLabel.textContent = fmt(PRECO);
  await loadVendidos();
  renderGrid();
  updatePanel();
}
init();

/* ====== A√á√ïES ====== */
btnClear.addEventListener('click', ()=>{
  selecionados.clear();
  updatePanel();
  renderGrid();
});

btnConfirm.addEventListener('click', ()=>{
  const arr = Array.from(selecionados).sort((a,b)=>a-b);
  numsPreview.textContent = arr.join(', ');
  openPopup();
});

cancelEl.addEventListener('click', closePopup);

/* ====== ENVIAR ====== */
confirmEl.addEventListener('click', async ()=>{
  const nome = nomeEl.value.trim();
  const email = emailEl.value.trim();
  const tel = telEl.value.trim();
  const numeros = Array.from(selecionados).sort((a,b)=>a-b);

  if(!nome || !email || !tel || numeros.length===0){
    alert('Preencha os dados e selecione pelo menos um n√∫mero.');
    return;
  }

  showOverlay(true);
  try{
    const payload = {
      action: "registrar_rifa",
      nome, email, telefone: tel,
      numeros, // array
      quantidade: numeros.length,
      total: numeros.length * PRECO
    };
    const res = await fetch(RIFA_SCRIPT_URL, {
      method: "POST",
      headers: {"Content-Type":"text/plain;charset=utf-8"},
      body: JSON.stringify(payload)
    });
    const text = await res.text();
    showOverlay(false);

    if(/OK/i.test(text)){
      alert('‚úÖ Participa√ß√£o registrada! Seus n√∫meros foram reservados.');
      closePopup();
      // recarrega status de vendidos e limpa sele√ß√£o
      selecionados.clear();
      await loadVendidos();
      renderGrid(); updatePanel();
    }else if(/DUPLICADO|RESERVADO/i.test(text)){
      alert('‚ö†Ô∏è Alguns n√∫meros j√° foram reservados enquanto voc√™ preenchia. Atualizamos a lista.');
      await loadVendidos(); renderGrid(); updatePanel(); closePopup();
    }else{
      alert('‚ùå N√£o foi poss√≠vel enviar. Tente novamente.');
    }
  }catch(e){
    showOverlay(false);
    alert('Falha de conex√£o.');
  }
});
</script>
</body>
</html>
